<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ù…Ù†ØµÙ‘Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙ Ø§Ù„Ø°ÙƒÙŠØ©</title>
<style>
:root{
  --bg:#0b1020; --card:#111a35; --card2:#0e1631; --line:#2a3355;
  --gold:#D4AF37; --txt:#fff; --muted:#b9c0d6;
  --ok:#2EA043; --warn:#F59F00; --bad:#E24B4B; --vio:#4C2F8C;
}
*{box-sizing:border-box}
body{margin:0;padding:14px;font-family:Tahoma,Arial;background:var(--bg);color:var(--txt)}
h1{margin:0 0 6px;color:var(--gold);font-weight:1000;text-align:center}
p{margin:4px 0;color:var(--muted);font-weight:700}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;margin-top:12px}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px}
.card2{background:var(--card2);border:1px solid var(--line);border-radius:16px;padding:14px}
.span-12{grid-column:span 12}
.span-8{grid-column:span 8}
.span-4{grid-column:span 4}
@media (max-width:980px){.span-8,.span-4{grid-column:span 12} body{padding:10px}}
label{display:block;font-size:12px;color:var(--muted);margin:6px 0 4px}
input,select,textarea{
  width:100%;padding:10px 11px;border-radius:12px;border:1px solid var(--line);
  background:#0b1430;color:var(--txt);outline:none
}
textarea{min-height:90px;resize:vertical}
.btns{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
button{
  border:none;padding:10px 12px;border-radius:999px;cursor:pointer;
  background:var(--gold);color:#0b1020;font-weight:1000
}
button.ghost{background:transparent;color:var(--txt);border:1px solid var(--line)}
button.ok{background:var(--ok);color:#0b1020}
button.warn{background:var(--warn);color:#0b1020}
button.bad{background:var(--bad);color:#fff}
button.vio{background:var(--vio);color:#fff}
.hr{height:1px;background:var(--line);margin:12px 0}
.note{padding:10px;border-radius:12px;background:#0b1430;border:1px dashed var(--line);color:var(--muted);line-height:1.75}
.small{font-size:12px;color:var(--muted);line-height:1.6}
.tag{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:1000}
.t-ok{background:rgba(46,160,67,.18);color:#bff2c7;border:1px solid rgba(46,160,67,.35)}
.t-warn{background:rgba(245,159,0,.18);color:#ffe1a6;border:1px solid rgba(245,159,0,.35)}
.t-bad{background:rgba(226,75,75,.18);color:#ffb7b7;border:1px solid rgba(226,75,75,.35)}
.t-gold{background:rgba(212,175,55,.14);color:#ffe8a6;border:1px solid rgba(212,175,55,.35)}
.t-vio{background:rgba(76,47,140,.18);color:#d7c7ff;border:1px solid rgba(76,47,140,.35)}
.hidden{display:none}

/* ===== Ø§Ù„ØºÙ„Ø§Ù ===== */
.cover{
  border-radius:18px;border:1px solid var(--line);overflow:hidden;
  background:
    radial-gradient(900px 450px at 10% 18%, rgba(212,175,55,.30), transparent 60%),
    radial-gradient(900px 520px at 90% 26%, rgba(76,47,140,.30), transparent 60%),
    radial-gradient(850px 620px at 50% 110%, rgba(46,160,67,.20), transparent 60%),
    linear-gradient(135deg,#0b1430,#0b1020);
}
.coverInner{padding:18px}
.coverHeader{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
.badge{
  padding:6px 10px;border-radius:999px;border:1px solid rgba(212,175,55,.35);
  background:rgba(212,175,55,.12);color:#ffe8a6;font-weight:1000;font-size:12px
}
.coverHero{
  margin-top:14px;border-radius:18px;border:1px solid rgba(212,175,55,.25);
  background:rgba(11,20,48,.55);padding:18px;text-align:center;position:relative;overflow:hidden;
}
.coverHero:before{
  content:"";position:absolute;inset:-40px;
  background:
    radial-gradient(200px 200px at 15% 20%, rgba(212,175,55,.20), transparent 60%),
    radial-gradient(220px 220px at 85% 30%, rgba(76,47,140,.20), transparent 65%),
    radial-gradient(260px 260px at 50% 95%, rgba(46,160,67,.12), transparent 70%);
  filter:blur(2px);
}
.coverHero>*{position:relative}
.coverCalligraphy{
  font-family:"Amiri","Scheherazade New","Noto Naskh Arabic",Tahoma,Arial;
  font-weight:900;font-size:34px;color:var(--gold);letter-spacing:.5px;margin:0;
}
.coverLine{
  width:min(520px,90%);height:1px;
  background:linear-gradient(90deg,transparent,rgba(212,175,55,.75),transparent);
  margin:10px auto;
}
.coverIcons{display:flex;justify-content:center;gap:10px;flex-wrap:wrap;margin-top:10px}
.pill{
  padding:6px 10px;border-radius:999px;border:1px solid rgba(42,51,85,.9);
  background:rgba(14,20,48,.55);color:#e8ecff;font-weight:900;font-size:12px;
}
.brandSmall{font-weight:1000;color:#e8ecff;opacity:.95}
.rights{margin-top:14px;text-align:center;color:rgba(255,255,255,.55);font-size:12px}

/* ===== Ø§Ù„Ø¹Ø¬Ù„Ø§Øª (Ø³Ø±ÙŠØ¹Ø©) ===== */
.wheelsGrid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
@media (max-width:980px){.wheelsGrid{grid-template-columns:1fr}}
.wheelWrap{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.wheel{
  width:170px;height:170px;border-radius:50%;
  background:conic-gradient(#D4AF37,#4C2F8C,#2EA043,#F59F00,#E24B4B,#1A2A50,#D4AF37);
  border:6px solid rgba(255,255,255,.08);
  box-shadow:0 12px 30px rgba(0,0,0,.35);
  position:relative;transform:rotate(0deg);
  transition:transform .95s cubic-bezier(.12,.92,.12,1); /* Ø£Ø³Ø±Ø¹ */
}
.wheel:after{
  content:"";position:absolute;top:-14px;left:50%;transform:translateX(-50%);
  width:0;height:0;border-left:10px solid transparent;border-right:10px solid transparent;border-bottom:16px solid var(--gold);
  filter:drop-shadow(0 2px 2px rgba(0,0,0,.4));
}
.wheelCenter{
  position:absolute;inset:0;margin:auto;width:52px;height:52px;border-radius:50%;
  background:#0b1430;border:2px solid rgba(212,175,55,.55);
  display:flex;align-items:center;justify-content:center;font-weight:1000;color:var(--gold)
}

/* ===== Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ===== */
.groupBox{
  border:1px solid var(--line);border-radius:14px;padding:10px;background:#0b1430;min-height:170px;
}
.groupTitle{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;font-weight:1000}
.dropHint{
  margin-top:8px;padding:8px;border-radius:12px;border:1px dashed rgba(212,175,55,.35);
  color:#ffe8a6;background:rgba(212,175,55,.08);font-size:12px;
}
.groupList{margin-top:8px;display:flex;flex-direction:column;gap:6px}
.stRow{
  display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between;
  padding:8px;border-radius:12px;border:1px solid rgba(42,51,85,.85);background:rgba(14,20,48,.55);
}
.stRow .name{font-weight:1000}
.miniBtns{display:flex;gap:6px;flex-wrap:wrap}
.miniBtns button{padding:7px 9px;font-weight:1000}

/* ===== Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØµÙ ===== */
.roster{
  border:1px solid var(--line);border-radius:14px;padding:10px;background:#0b1430;
  max-height:340px;overflow:auto;
}
.rosterItem{
  display:flex;justify-content:space-between;align-items:center;gap:8px;
  padding:8px;border-radius:12px;border:1px solid rgba(42,51,85,.85);
  background:rgba(14,20,48,.55);margin:6px 0;
}
.drag{cursor:grab;user-select:none}

/* Ø¬Ø¯ÙˆÙ„ */
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid var(--line);padding:8px;text-align:center;white-space:nowrap}
th{background:#0b1430}
</style>
</head>
<body>

<!-- Ø§Ù„ØºÙ„Ø§Ù -->
<div id="cover" class="cover">
  <div class="coverInner">
    <div class="coverHeader">
      <div class="brandSmall" id="metaPlatformNameTop">Ù…Ù†ØµÙ‘Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙ Ø§Ù„Ø°ÙƒÙŠØ©</div>
      <div class="badge">ØªØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª â€¢ ØªØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</div>
    </div>

    <div class="coverHero">
      <h1 class="coverCalligraphy">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©</h1>
      <div class="coverLine"></div>
      <div class="small" id="metaTag" style="margin-top:6px">Ø¹Ø¬Ù„Ø© â€¢ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª â€¢ Ø­Ø¶ÙˆØ± ÙˆØºÙŠØ§Ø¨ â€¢ ØªØ­ÙÙŠØ² â€¢ Ø±Ø³Ø§Ø¦Ù„ Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±</div>
      <div class="coverIcons">
        <div class="pill">ğŸ¡ Ø¹Ø¬Ù„Ø© Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª</div>
        <div class="pill">ğŸ¡ Ø¹Ø¬Ù„Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</div>
        <div class="pill">âœ… Ø­Ø¶ÙˆØ±</div>
        <div class="pill">ğŸ… ØªØ­ÙÙŠØ²</div>
        <div class="pill">âœ‰ï¸ Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±</div>
      </div>
    </div>

    <div class="grid" style="margin-top:12px">
      <div class="card2 span-6">
        <div class="small">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</div>
        <div style="margin-top:6px;font-weight:1000" id="metaSchoolName">Ø§Ù„Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© ÙˆØ§Ù„Ø£Ø±Ø¨Ø¹ÙˆÙ† â€“ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„Ø³Ø§Ø¯Ø³Ø© ÙˆØ§Ù„Ø«Ù„Ø§Ø«ÙˆÙ†</div>
        <div class="small" style="margin-top:8px" id="metaPrincipalName">Ù…Ø¯ÙŠØ±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: Ø£/ Ø¢Ù…Ø§Ù„ Ø¨Ø§Ø±Ø¨ÙˆØ¯</div>
        <div class="small" style="margin-top:4px" id="metaTeacherName">Ø§Ù„Ù…Ø¹Ù„Ù…Ø©: Ø³Ø¹Ø§Ø¯ Ø§Ù„ØºØ§Ù…Ø¯ÙŠ</div>
        <div class="small" style="margin-top:4px" id="metaTeacherEmailShow">Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø¹Ù„Ù…Ø©: â€”</div>
      </div>

      <div class="card2 span-6">
        <div class="small">Ù…Ø²Ø§ÙŠØ§ Ø§Ù„Ù…Ù†ØµÙ‘Ø©</div>
        <div class="note" style="margin-top:10px">
          âœ… ÙØµÙˆÙ„ Ù…ØªØ¹Ø¯Ø¯Ø© + Ø­ÙØ¸ Ù…Ù†ÙØµÙ„ Ù„ÙƒÙ„ ÙØµÙ„<br>
          âœ… Ø³Ø­Ø¨ ÙˆØ¥ÙÙ„Ø§Øª Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª<br>
          âœ… Ø¹Ø¬Ù„Ø© Ù„Ù„Ø·Ø§Ù„Ø¨Ø§Øª + Ø¹Ø¬Ù„Ø© Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª<br>
          âœ… Ø§Ù„Ø·Ø§Ù„Ø¨Ø© Ø§Ù„Ø³Ø±Ù‘ÙŠØ© (ØªØ¹ÙŠÙŠÙ†/Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø±)<br>
          âœ… Ø¥Ù†Ø°Ø§Ø±/ØªØ¹Ø²ÙŠØ² + Ù†Ù‚Ø§Ø· Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ù…ØªØ¹Ø§ÙˆÙ†Ø©
        </div>
      </div>
    </div>

    <div class="btns" style="margin-top:12px;justify-content:center">
      <button class="ok" onclick="enterApp()">Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…Ù†ØµÙ‘Ø©</button>
      <button class="ghost" onclick="toggleMetaEdit()">ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØºÙ„Ø§Ù</button>
      <button class="bad" onclick="wipeAll()">Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø¨Ø£Ù…Ø±Ùƒ)</button>
    </div>

    <div id="metaEdit" class="card2 hidden" style="margin-top:12px">
      <h3 style="margin:0 0 8px;color:var(--gold)">ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØºÙ„Ø§Ù</h3>
      <div class="small">ØªÙØ­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¯Ø§Ø®Ù„ Ø¬Ù‡Ø§Ø²Ùƒ.</div>
      <div class="grid" style="margin-top:8px">
        <div class="span-6">
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØµÙ‘Ø©</label><input id="inPlatform" />
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</label><input id="inSchool" />
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ±Ø©</label><input id="inPrincipal" />
        </div>
        <div class="span-6">
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…Ø©</label><input id="inTeacher" />
          <label>Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø¹Ù„Ù…Ø© (Ø£Ùˆ Ø§ØªØ±ÙƒÙŠÙ‡ Ù„Ù„ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ)</label><input id="inEmail" />
          <label>Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ÙØµÙˆÙ„ (Ø³Ø·Ø± Ù„ÙƒÙ„ ÙØµÙ„)</label>
          <textarea id="inClasses" placeholder="Ø«Ø§Ù†ÙŠØ© Ø£ÙˆÙ„&#10;Ø«Ø§Ù†ÙŠØ© Ø«Ø§Ù†ÙŠ&#10;Ø«Ø§Ù†ÙŠØ© Ø«Ø§Ù„Ø«&#10;Ø«Ø§Ù†ÙŠØ© Ø±Ø§Ø¨Ø¹"></textarea>
        </div>
      </div>
      <div class="btns" style="margin-top:10px">
        <button onclick="saveMeta()">Ø­ÙØ¸</button>
        <button class="ghost" onclick="toggleMetaEdit()">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>

    <div class="rights">Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ø·Ø¨Ø¹ Â© 2026</div>
  </div>
</div>

<!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
<div id="app" class="hidden">
  <h1 id="appH1">Ù…Ù†ØµÙ‘Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙ Ø§Ù„Ø°ÙƒÙŠØ©</h1>
  <p id="appSchool">Ø§Ù„Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© ÙˆØ§Ù„Ø£Ø±Ø¨Ø¹ÙˆÙ† â€“ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„Ø³Ø§Ø¯Ø³Ø© ÙˆØ§Ù„Ø«Ù„Ø§Ø«ÙˆÙ†</p>
  <p id="appPrincipal">Ù…Ø¯ÙŠØ±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: Ø£/ Ø¢Ù…Ø§Ù„ Ø¨Ø§Ø±Ø¨ÙˆØ¯</p>
  <p id="appTeacher">Ø§Ù„Ù…Ø¹Ù„Ù…Ø©: Ø³Ø¹Ø§Ø¯ Ø§Ù„ØºØ§Ù…Ø¯ÙŠ</p>
  <p class="small" id="appEmail">Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø¹Ù„Ù…Ø©: â€”</p>

  <div class="grid">

    <div class="card span-12">
      <div class="btns">
        <button class="ghost" onclick="backToCover()">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØºÙ„Ø§Ù</button>
        <button class="ghost" onclick="exportJSON()">ØªØµØ¯ÙŠØ± Ù†Ø³Ø®Ø© (JSON)</button>
        <button class="ghost" onclick="importJSON()">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù†Ø³Ø®Ø© (JSON)</button>
        <button class="ghost" onclick="printKashf()">Ø·Ø¨Ø§Ø¹Ø© ÙƒØ´Ù</button>
        <button class="bad" onclick="wipeAll()">Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø¨Ø£Ù…Ø±Ùƒ)</button>
      </div>
      <div class="small">Ù…Ù„Ø§Ø­Ø¸Ø©: ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙØ­ÙØ¸ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ ÙÙ‚Ø·.</div>
    </div>

    <!-- ÙŠØ³Ø§Ø± -->
    <div class="card span-4">
      <h3 style="margin:0 0 10px">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØµÙˆÙ„</h3>

      <label>Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØµÙ„</label>
      <select id="classSelect" onchange="syncAll()"></select>

      <div class="hr"></div>

      <h3 style="margin:0 0 10px">Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨Ø©</h3>
      <label>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨Ø©</label>
      <input id="studentName" placeholder="Ø§ÙƒØªØ¨ÙŠ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨Ø©">

      <div class="btns">
        <button onclick="addStudent()">Ø¥Ø¶Ø§ÙØ© ÙˆØ­ÙØ¸</button>
        <button class="ghost" onclick="bulkAdd()">Ø¥Ø¶Ø§ÙØ© Ø¬Ù…Ø§Ø¹ÙŠØ© (Ø³Ø·Ø± Ù„ÙƒÙ„ Ø§Ø³Ù…)</button>
      </div>

      <div class="hr"></div>

      <h3 style="margin:0 0 8px">Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø¹Ù„Ù…Ø© (ØªÙˆÙ„ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ)</h3>
      <div class="btns">
        <button class="vio" onclick="autoGenerateTeacherEmail()">ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¨Ø±ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</button>
        <button class="ghost" onclick="saveTeacherEmail()">Ø­ÙØ¸ Ø§Ù„Ø¨Ø±ÙŠØ¯</button>
      </div>
      <input id="teacherEmail" placeholder="example@school.edu">
      <div class="small" id="emailHint">â€”</div>

      <div class="hr"></div>

      <h3 style="margin:0 0 8px">Ø§Ù„Ø·Ø§Ù„Ø¨Ø© Ø§Ù„Ø³Ø±Ù‘ÙŠØ©</h3>
      <div class="btns">
        <button class="vio" onclick="setSecret()">ØªØ¹ÙŠÙŠÙ† Ø³Ø±Ù‘ÙŠØ©</button>
        <button class="ghost" onclick="hideSecret()">Ø¥Ø®ÙØ§Ø¡</button>
        <button class="ok" onclick="revealSecret()">Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø³Ø±Ù‘ÙŠØ©</button>
        <button class="vio" onclick="newSecret()">Ø³Ø±Ù‘ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</button>
      </div>
      <div class="note" id="secretBox">â€”</div>

      <div class="hr"></div>

      <h3 style="margin:0 0 8px">Ø±Ø³Ø§Ø¦Ù„ Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±</h3>
      <label>Ø§Ø®ØªØ§Ø±ÙŠ Ø·Ø§Ù„Ø¨Ø©</label>
      <select id="msgStudent"></select>
      <div class="btns">
        <button class="ghost" onclick="copyParentMsg('praise')">ØªØ´Ø¬ÙŠØ¹</button>
        <button class="ghost" onclick="copyParentMsg('warn')">ØªÙ†Ø¨ÙŠÙ‡</button>
        <button class="ghost" onclick="copyParentMsg('absence')">ØºÙŠØ§Ø¨/ØªØ£Ø®Ø±</button>
      </div>
      <div class="note" id="parentMsgBox">â€”</div>
    </div>

    <!-- ÙŠÙ…ÙŠÙ† -->
    <div class="card span-8">
      <h2 style="margin:0;color:var(--gold)">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙÙ‘ÙŠØ©</h2>
      <div class="small">Ø³Ø­Ø¨ ÙˆØ¥ÙÙ„Ø§Øª Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª + Ø¹Ø¬Ù„Ø© Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª + Ø¹Ø¬Ù„Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª + Ø­Ø¶ÙˆØ±/ØºÙŠØ§Ø¨/ØªØ£Ø®Ø± + Ù†Ù‚Ø§Ø·.</div>

      <div class="hr"></div>

      <div class="btns">
        <button class="warn" onclick="classNoise()">Ø§Ù„ÙØµÙ„ Ù…Ø²Ø¹Ø¬ (Ø¥Ù†Ø°Ø§Ø±)</button>
        <button class="ok" onclick="classCalm()">Ø§Ù„ÙØµÙ„ Ù…ØªØ¹Ø§ÙˆÙ† (ØªØ¹Ø²ÙŠØ² + Ù†Ù‚Ø§Ø· Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©)</button>
        <button class="ghost" onclick="calmDown()">ØªÙ‡Ø¯Ø¦Ø© (Ø®ØµÙ… Ø¥Ù†Ø°Ø§Ø±)</button>
      </div>
      <div id="classStatusBox" class="note" style="margin-top:10px">â€”</div>

      <div class="hr"></div>

      <h3 style="margin:0 0 8px">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØµÙ (Ø§Ø³Ø­Ø¨ÙŠ Ø§Ù„Ø·Ø§Ù„Ø¨Ø© Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©)</h3>
      <div class="roster" id="roster"></div>

      <div class="hr"></div>

      <h3 style="margin:0 0 8px">ğŸ¡ Ø§Ù„Ø¹Ø¬Ù„Ø§Øª (ÙˆØ§Ø­Ø¯Ø© Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª + ÙˆØ§Ø­Ø¯Ø© Ù„Ù„Ø·Ø§Ù„Ø¨Ø§Øª)</h3>

      <div class="wheelsGrid">

        <!-- Ø¹Ø¬Ù„Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª -->
        <div class="card2">
          <div class="wheelWrap">
            <div class="wheel" id="wheelGroup"><div class="wheelCenter">ğŸ‘¥</div></div>
            <div style="flex:1;min-width:240px">
              <div class="btns">
                <button class="vio" onclick="spinGroupWheel()">ØªØ¯ÙˆÙŠØ± Ø¹Ø¬Ù„Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</button>
                <button class="ghost" onclick="toggleNoRepeatGroups()">Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</button>
              </div>
              <div class="note" id="pickGroupResult" style="margin-top:10px">
                <b>Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©:</b> â€”<br><span class="small">ØªØ®ØªØ§Ø± Ù…Ù†: Ø§Ù„Ù…Ø¨Ø¯Ø¹Ø§ØªØŒ Ø§Ù„Ø·Ù…ÙˆØ­Ø§ØªØŒ Ø§Ù„Ù…ÙˆÙ‡ÙˆØ¨Ø§ØªØŒ Ø§Ù„Ù…ØªÙ…ÙŠØ²Ø§Øª (Ù…Ø¹ ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ÙØ§Ø±ØºØ©).</span>
              </div>
              <div class="btns" style="margin-top:8px">
                <button onclick="awardPointsToChosenGroup(+5)">+5 Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©</button>
                <button onclick="awardPointsToChosenGroup(+10)">+10 Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Ø¹Ø¬Ù„Ø© Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª -->
        <div class="card2">
          <div class="wheelWrap">
            <div class="wheel" id="wheelStudent"><div class="wheelCenter">ğŸ“</div></div>
            <div style="flex:1;min-width:240px">
              <div class="btns">
                <button class="vio" onclick="spinStudentWheel()">ØªØ¯ÙˆÙŠØ± Ø¹Ø¬Ù„Ø© Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª</button>
                <button class="ghost" onclick="toggleNoRepeatStudents()">Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª</button>
              </div>

              <div class="btns" style="margin-top:8px">
                <button class="ghost" onclick="toggleStudentWheelMode()">Ù†Ù…Ø· Ø§Ù„Ø¹Ø¬Ù„Ø©: <span id="wheelModeTxt">ÙƒÙ„ Ø§Ù„ØµÙ</span></button>
              </div>

              <div class="note" id="pickStudentResult" style="margin-top:10px">
                <b>Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø·Ø§Ù„Ø¨Ø©:</b> â€”<br><span class="small">Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù†Ù…Ø· "Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø®ØªØ§Ø±Ø©": Ù„Ø§Ø²Ù… ØªØ®ØªØ§Ø±ÙŠÙ† Ù…Ø¬Ù…ÙˆØ¹Ø© Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† Ø¹Ø¬Ù„Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª.</span>
              </div>

              <div class="btns" style="margin-top:8px">
                <button class="ok" onclick="rewardPicked()">+10 Ù„Ù„Ø·Ø§Ù„Ø¨Ø©</button>
                <button class="warn" onclick="warnPicked()">ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„Ø·Ø§Ù„Ø¨Ø©</button>
                <button onclick="awardGroupPointsPicked()">+10 Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø·Ø§Ù„Ø¨Ø©</button>
              </div>
            </div>
          </div>

          <div class="hr"></div>
          <div class="small"><b>Ù…Ø­ØªÙˆÙ‰ Ø¹Ø¬Ù„Ø© Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª (Ù…Ù† Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ØµÙ):</b></div>
          <div class="note" id="wheelStudentsList" style="margin-top:8px">â€”</div>
        </div>

      </div>

      <div class="hr"></div>

      <h3 style="margin:0 0 8px">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ø£Ø±Ø¨Ø¹</h3>
      <div class="grid">
        <div class="span-6"><div class="groupBox" id="g1" ondragover="allowDrop(event)" ondrop="dropToGroup(event,1)"></div></div>
        <div class="span-6"><div class="groupBox" id="g2" ondragover="allowDrop(event)" ondrop="dropToGroup(event,2)"></div></div>
        <div class="span-6"><div class="groupBox" id="g3" ondragover="allowDrop(event)" ondrop="dropToGroup(event,3)"></div></div>
        <div class="span-6"><div class="groupBox" id="g4" ondragover="allowDrop(event)" ondrop="dropToGroup(event,4)"></div></div>
      </div>

      <div class="hr"></div>

      <h3 style="margin:0 0 6px">ÙƒØ´Ù Ø§Ù„Ø­Ø¶ÙˆØ±</h3>
      <div class="small">Ø§Ø¶ØºØ·ÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø§Ù„Ø¨Ø© Ù„Ù„ØªØ¨Ø¯ÙŠÙ„: Ø­Ø§Ø¶Ø±Ø© âœ… â†’ ØºØ§Ø¦Ø¨Ø© âŒ â†’ Ù…ØªØ£Ø®Ø±Ø© â³ â†’ Ø­Ø§Ø¶Ø±Ø© âœ…</div>
      <div style="overflow:auto">
        <table id="kashfTable"></table>
      </div>

      <div class="hr"></div>
      <h3 style="margin:0 0 6px">Ø³Ø¬Ù„ Ø§Ù„Ø­ØµØ©</h3>
      <textarea id="sessionLog" readonly></textarea>

    </div>

  </div>
</div>

<script>
/* ===================== Ø§Ù„ØªØ®Ø²ÙŠÙ† ===================== */
const STORE="smart_class_all_classes_v3";
let data = JSON.parse(localStorage.getItem(STORE) || "null");

function defaultData(){
  return {
    meta:{
      platformName:"Ù…Ù†ØµÙ‘Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙ Ø§Ù„Ø°ÙƒÙŠØ©",
      school:"Ø§Ù„Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© ÙˆØ§Ù„Ø£Ø±Ø¨Ø¹ÙˆÙ† â€“ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„Ø³Ø§Ø¯Ø³Ø© ÙˆØ§Ù„Ø«Ù„Ø§Ø«ÙˆÙ†",
      principal:"Ù…Ø¯ÙŠØ±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: Ø£/ Ø¢Ù…Ø§Ù„ Ø¨Ø§Ø±Ø¨ÙˆØ¯",
      teacher:"Ø§Ù„Ù…Ø¹Ù„Ù…Ø©: Ø³Ø¹Ø§Ø¯ Ø§Ù„ØºØ§Ù…Ø¯ÙŠ",
      email:""
    },
    classOrder:["Ø«Ø§Ù†ÙŠØ© Ø£ÙˆÙ„","Ø«Ø§Ù†ÙŠØ© Ø«Ø§Ù†ÙŠ","Ø«Ø§Ù†ÙŠØ© Ø«Ø§Ù„Ø«","Ø«Ø§Ù†ÙŠØ© Ø±Ø§Ø¨Ø¹"],
    classes:{
      "Ø«Ø§Ù†ÙŠØ© Ø£ÙˆÙ„": { students:[], secret:null, secretHidden:true },
      "Ø«Ø§Ù†ÙŠØ© Ø«Ø§Ù†ÙŠ": { students:[], secret:null, secretHidden:true },
      "Ø«Ø§Ù†ÙŠØ© Ø«Ø§Ù„Ø«": { students:[], secret:null, secretHidden:true },
      "Ø«Ø§Ù†ÙŠØ© Ø±Ø§Ø¨Ø¹": { students:[], secret:null, secretHidden:true }
    },
    sessions:{}
  };
}
if(!data) data = defaultData();
saveSilent();

function saveSilent(){ localStorage.setItem(STORE, JSON.stringify(data)); }
function save(){ saveSilent(); syncAll(); }

/* ===================== Ø£Ø¯ÙˆØ§Øª ===================== */
const el=(id)=>document.getElementById(id);
const esc=(s)=>String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
const today=()=>new Date().toISOString().slice(0,10);
const nowTime=()=>new Date().toLocaleTimeString('ar-SA',{hour:'2-digit',minute:'2-digit'});

function classNames(){
  const set=new Set(data.classOrder || []);
  Object.keys(data.classes||{}).forEach(k=>set.add(k));
  return [...set];
}
function getClass(name){ return data.classes[name]; }

/* Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª */
const groupNames = {1:"Ø§Ù„Ù…Ø¨Ø¯Ø¹Ø§Øª",2:"Ø§Ù„Ø·Ù…ÙˆØ­Ø§Øª",3:"Ø§Ù„Ù…ÙˆÙ‡ÙˆØ¨Ø§Øª",4:"Ø§Ù„Ù…ØªÙ…ÙŠØ²Ø§Øª"};
function groupIdByName(n){
  const e = Object.entries(groupNames).find(([k,v])=>v===n);
  return e ? (+e[0]) : null;
}

/* ===================== Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ© ===================== */
function makeSession(){
  return {
    date: today(),
    warnings:0, praise:0, noisy:false,
    noRepeatStudents:true,
    noRepeatGroups:false,
    usedStudentIds:[],
    usedGroups:[],
    chosenGroup:null,   // 1..4
    pickedId:null,      // student id
    wheelMode:"all",    // "all" Ø£Ùˆ "group" (Ù„Ø·Ø§Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©)
    log:`${today()} â€” ØªÙ… Ø¨Ø¯Ø¡ Ø¬Ù„Ø³Ø© Ø§Ù„ÙŠÙˆÙ….\n`,
    attendance:{},   // id -> 0 present 1 absent 2 late
    points:{},       // Ù†Ù‚Ø§Ø· Ø§Ù„Ø·Ø§Ù„Ø¨Ø©
    warns:{},        // ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨Ø©
    groupPoints:{1:0,2:0,3:0,4:0} // Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
  };
}
function ensureSession(className){
  if(!data.sessions[className]) data.sessions[className]=makeSession();
  if(data.sessions[className].date !== today()){
    data.sessions[className]=makeSession();
    data.sessions[className].log=`${today()} â€” ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.\n`;
  }
  return data.sessions[className];
}
function logAct(className,msg){
  const s=ensureSession(className);
  s.log = `${nowTime()} â€” ${msg}\n` + (s.log||"");
}

/* ===================== ØªÙ†Ù‚Ù„/ØºÙ„Ø§Ù ===================== */
function enterApp(){
  el("cover").classList.add("hidden");
  el("app").classList.remove("hidden");
  syncAll();
}
function backToCover(){
  el("app").classList.add("hidden");
  el("cover").classList.remove("hidden");
  renderMeta();
}
function toggleMetaEdit(){
  el("metaEdit").classList.toggle("hidden");
  const m=data.meta;
  el("inPlatform").value=m.platformName||"";
  el("inSchool").value=m.school||"";
  el("inPrincipal").value=m.principal||"";
  el("inTeacher").value=m.teacher||"";
  el("inEmail").value=m.email||"";
  el("inClasses").value = classNames().join("\n");
}
function saveMeta(){
  data.meta.platformName = (el("inPlatform").value||"").trim() || "Ù…Ù†ØµÙ‘Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙ Ø§Ù„Ø°ÙƒÙŠØ©";
  data.meta.school = (el("inSchool").value||"").trim() || "";
  data.meta.principal = (el("inPrincipal").value||"").trim() || "";
  data.meta.teacher = (el("inTeacher").value||"").trim() || "";
  data.meta.email = (el("inEmail").value||"").trim() || "";

  const lines = (el("inClasses").value||"").split("\n").map(x=>x.trim()).filter(Boolean);
  if(lines.length){
    data.classOrder = lines;
    lines.forEach(name=>{
      if(!data.classes[name]) data.classes[name]={ students:[], secret:null, secretHidden:true };
    });
  }
  save();
  toggleMetaEdit();
  renderMeta();
}
function renderMeta(){
  const m=data.meta;
  el("metaPlatformNameTop").textContent = m.platformName;
  el("metaSchoolName").textContent = m.school;
  el("metaPrincipalName").textContent = m.principal;
  el("metaTeacherName").textContent = m.teacher;
  el("metaTeacherEmailShow").textContent = "Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø¹Ù„Ù…Ø©: " + (m.email || "â€”");

  el("appH1").textContent = m.platformName;
  el("appSchool").textContent = m.school;
  el("appPrincipal").textContent = m.principal;
  el("appTeacher").textContent = m.teacher;
  el("appEmail").textContent = "Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø¹Ù„Ù…Ø©: " + (m.email || "â€”");
}

/* ===================== Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø¹Ù„Ù…Ø© (ØªÙˆÙ„ÙŠØ¯) ===================== */
function slugifyEmailBase(name){
  const cleaned = String(name||"").trim();
  const latin = cleaned
    .replace(/[\u064B-\u065F]/g,"")
    .replace(/\s+/g,".")
    .replace(/[^\w.\-]/g,"")
    .toLowerCase();
  return latin || "teacher";
}
function autoGenerateTeacherEmail(){
  const base = slugifyEmailBase(data.meta.teacher || "teacher");
  const email = `${base}@school.edu`;
  data.meta.email = email;
  el("teacherEmail").value = email;
  logAct(currentClass(), `ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø¹Ù„Ù…Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§: ${email}`);
  save();
  alert("ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆØ­ÙØ¸Ù‡.");
}
function saveTeacherEmail(){
  data.meta.email = (el("teacherEmail").value||"").trim();
  save();
  alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨Ø±ÙŠØ¯.");
}

/* ===================== Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØµÙ„ ===================== */
function renderClassSelector(){
  const sel=el("classSelect");
  sel.innerHTML="";
  classNames().forEach(name=>{
    sel.innerHTML += `<option value="${esc(name)}">${esc(name)}</option>`;
  });
  if(!sel.value) sel.value = classNames()[0] || "";
}
function currentClass(){ return el("classSelect").value; }

/* ===================== Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª ===================== */
function nextId(cls){
  let max=0;
  cls.students.forEach(s=>{
    const n=parseInt(s.id,10);
    if(!isNaN(n)) max=Math.max(max,n);
  });
  return String(max+1).padStart(3,'0');
}

/* ===================== Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª ===================== */
function addStudent(){
  const cname=currentClass();
  const cls=getClass(cname);
  const name=(el("studentName").value||"").trim();
  if(!name) return;
  const id = nextId(cls);
  cls.students.push({ id, name, group: 0 });
  el("studentName").value="";
  logAct(cname, `Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨Ø©: ${name} (${id})`);
  save();
}
function bulkAdd(){
  const cname=currentClass();
  const cls=getClass(cname);
  const text = prompt("Ø§Ù„ØµÙ‚ÙŠ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª (ÙƒÙ„ Ø§Ø³Ù… ÙÙŠ Ø³Ø·Ø±):");
  if(!text) return;
  const lines = text.split("\n").map(x=>x.trim()).filter(Boolean);
  if(!lines.length) return;
  lines.forEach(n=>{
    const id = nextId(cls);
    cls.students.push({ id, name:n, group:0 });
  });
  logAct(cname, `Ø¥Ø¶Ø§ÙØ© Ø¬Ù…Ø§Ø¹ÙŠØ©: ${lines.length} Ø·Ø§Ù„Ø¨Ø©`);
  save();
}
function editStudentName(id,value){
  const cname=currentClass();
  const cls=getClass(cname);
  const st=cls.students.find(x=>x.id===id);
  if(!st) return;
  st.name = (value||"").trim() || st.name;
  save();
}
function deleteStudent(id){
  const cname=currentClass();
  const cls=getClass(cname);
  if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ÙŠÙ† Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨Ø©ØŸ")) return;
  cls.students = cls.students.filter(x=>x.id!==id);

  const s=ensureSession(cname);
  delete s.attendance[id];
  delete s.points[id];
  delete s.warns[id];
  s.usedStudentIds = (s.usedStudentIds||[]).filter(x=>x!==id);
  if(s.pickedId===id) s.pickedId=null;

  logAct(cname, `Ø­Ø°Ù Ø·Ø§Ù„Ø¨Ø© (${id})`);
  save();
}

/* ===================== Ø³Ø­Ø¨ ÙˆØ¥ÙÙ„Ø§Øª ===================== */
function allowDrop(ev){ ev.preventDefault(); }
function dragStudent(ev, id){ ev.dataTransfer.setData("studentId", id); }
function dropToGroup(ev, group){
  ev.preventDefault();
  const id = ev.dataTransfer.getData("studentId");
  const cname=currentClass();
  const cls=getClass(cname);
  const st=cls.students.find(x=>x.id===id);
  if(!st) return;
  st.group = group;
  logAct(cname, `Ø¥Ø³Ù†Ø§Ø¯ Ø§Ù„Ø·Ø§Ù„Ø¨Ø© (${id}) Ø¥Ù„Ù‰ Ù…Ø¬Ù…ÙˆØ¹Ø©: ${groupNames[group]}`);
  save();
}

/* ===================== Ø­Ø¶ÙˆØ±/ØºÙŠØ§Ø¨/ØªØ£Ø®Ø± ===================== */
function cycleStatus(v){ return (v===0)?1:(v===1)?2:0; }
function statusTag(v){
  if(v===0) return `<span class="tag t-ok">Ø­Ø§Ø¶Ø±Ø© âœ…</span>`;
  if(v===1) return `<span class="tag t-bad">ØºØ§Ø¦Ø¨Ø© âŒ</span>`;
  return `<span class="tag t-warn">Ù…ØªØ£Ø®Ø±Ø© â³</span>`;
}
function toggleAttendance(id){
  const cname=currentClass();
  const s=ensureSession(cname);
  const cur=s.attendance[id] ?? 0;
  s.attendance[id] = cycleStatus(cur);
  logAct(cname, `ØªØ­Ø¯ÙŠØ« Ø­Ø¶ÙˆØ± (${id})`);
  save();
}

/* ===================== Ù†Ù‚Ø§Ø·/ØªÙ†Ø¨ÙŠÙ‡ ===================== */
function addPoints(id,delta){
  const cname=currentClass();
  const s=ensureSession(cname);
  s.points[id]=(s.points[id]??0)+delta;
  logAct(cname, `Ù†Ù‚Ø§Ø· Ù„Ù„Ø·Ø§Ù„Ø¨Ø© (${id}) ${delta>0?`+${delta}`:delta}`);
}
function addWarn(id){
  const cname=currentClass();
  const s=ensureSession(cname);
  s.warns[id]=(s.warns[id]??0)+1;
  logAct(cname, `ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„Ø·Ø§Ù„Ø¨Ø© (${id}) (+1)`);
}
function addGroupPoints(group,delta){
  const cname=currentClass();
  const s=ensureSession(cname);
  s.groupPoints[group]=(s.groupPoints[group]??0)+delta;
  logAct(cname, `Ù†Ù‚Ø§Ø· Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© (${groupNames[group]}) ${delta>0?`+${delta}`:delta}`);
}

/* ===================== Ø¥Ù†Ø°Ø§Ø±/ØªØ¹Ø²ÙŠØ² Ø§Ù„ØµÙ ===================== */
function classNoise(){
  const cname=currentClass();
  const s=ensureSession(cname);
  s.noisy=true;
  s.warnings++;
  el("classStatusBox").innerHTML = `âš ï¸ <b>Ø¥Ù†Ø°Ø§Ø±:</b> Ø§Ù„ÙØµÙ„ Ù…Ø²Ø¹Ø¬ â€” Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª: <b>${s.warnings}</b>`;
  logAct(cname, `âš ï¸ Ø¥Ù†Ø°Ø§Ø± Ù„Ù„ØµÙ â€” Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${s.warnings}`);
  save();
}
function classCalm(){
  const cname=currentClass();
  const cls=getClass(cname);
  const s=ensureSession(cname);
  s.noisy=false;
  s.praise++;

  // Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠÙ‹Ø§ Ù…Ù† ØºÙŠØ± Ø§Ù„ÙØ§Ø±ØºØ© ÙˆØ¥Ø¶Ø§ÙØ© Ù†Ù‚Ø§Ø· Ù„Ù‡Ø§
  let groups=[1,2,3,4].filter(g=>cls.students.some(st=>st.group===g));
  if(!groups.length) groups=[1,2,3,4];
  const g = groups[Math.floor(Math.random()*groups.length)];
  addGroupPoints(g, +10);

  el("classStatusBox").innerHTML = `ğŸŒŸ <b>ØªØ¹Ø²ÙŠØ²:</b> Ø§Ù„ÙØµÙ„ Ù…ØªØ¹Ø§ÙˆÙ† â€” ØªØ¹Ø²ÙŠØ²Ø§Øª: <b>${s.praise}</b> â€” +10 Ù†Ù‚Ø§Ø· Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© <b>${groupNames[g]}</b>`;
  logAct(cname, `ğŸŒŸ ØªØ¹Ø²ÙŠØ² Ù„Ù„ØµÙ (+10 Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© ${groupNames[g]})`);
  save();
}
function calmDown(){
  const cname=currentClass();
  const s=ensureSession(cname);
  if(s.warnings>0) s.warnings--;
  el("classStatusBox").innerHTML = `âœ… ØªÙ‡Ø¯Ø¦Ø© â€” Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª Ø§Ù„Ø¢Ù†: <b>${s.warnings}</b>`;
  logAct(cname, `âœ… ØªÙ‡Ø¯Ø¦Ø©: Ø®ØµÙ… Ø¥Ù†Ø°Ø§Ø± â€” Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${s.warnings}`);
  save();
}

/* ===================== Ø¹Ø¬Ù„Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª + Ø¹Ø¬Ù„Ø© Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª ===================== */
let rotGroup=0, rotStudent=0;
function spinAnim(elId, which){
  const add = 720 + Math.floor(Math.random()*720);
  if(which==="g"){ rotGroup += add; el(elId).style.transform = `rotate(${rotGroup}deg)`; }
  else { rotStudent += add; el(elId).style.transform = `rotate(${rotStudent}deg)`; }
}

function toggleNoRepeatStudents(){
  const cname=currentClass();
  const s=ensureSession(cname);
  s.noRepeatStudents = !s.noRepeatStudents;
  logAct(cname, s.noRepeatStudents ? "ØªÙ… ØªÙØ¹ÙŠÙ„ Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª." : "ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª.");
  save();
  alert(s.noRepeatStudents ? "Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª: Ù…ÙØ¹Ù„" : "Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª: Ù…Ù„ØºÙŠ");
}
function toggleNoRepeatGroups(){
  const cname=currentClass();
  const s=ensureSession(cname);
  s.noRepeatGroups = !s.noRepeatGroups;
  logAct(cname, s.noRepeatGroups ? "ØªÙ… ØªÙØ¹ÙŠÙ„ Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª." : "ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª.");
  save();
  alert(s.noRepeatGroups ? "Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª: Ù…ÙØ¹Ù„" : "Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª: Ù…Ù„ØºÙŠ");
}

function spinGroupWheel(){
  const cname=currentClass();
  const cls=getClass(cname);
  const s=ensureSession(cname);

  let groups=[1,2,3,4].filter(g=>cls.students.some(st=>st.group===g)); // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ÙØ§Ø±ØºØ©
  if(!groups.length) groups=[1,2,3,4];

  if(s.noRepeatGroups){
    const left = groups.filter(g => !s.usedGroups.includes(g));
    if(left.length) groups = left;
    else s.usedGroups = [];
  }

  const g = groups[Math.floor(Math.random()*groups.length)];
  s.chosenGroup = g;
  if(s.noRepeatGroups) s.usedGroups.push(g);

  spinAnim("wheelGroup","g");
  setTimeout(()=>{
    el("pickGroupResult").innerHTML = `<b>Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©:</b> <span class="tag t-vio">${groupNames[g]}</span>`;
    logAct(cname, `ğŸ¯ Ø¹Ø¬Ù„Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª: ${groupNames[g]}`);
    save();
  }, 550);
}

function toggleStudentWheelMode(){
  const cname=currentClass();
  const s=ensureSession(cname);
  s.wheelMode = (s.wheelMode==="all") ? "group" : "all";
  save();
}

function spinStudentWheel(){
  const cname=currentClass();
  const cls=getClass(cname);
  const s=ensureSession(cname);

  if(!cls.students.length) return alert("Ø£Ø¶ÙŠÙÙŠ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª Ø£ÙˆÙ„Ø§Ù‹.");

  let pool = cls.students.slice();

  // Ø¥Ø°Ø§ Ø§Ù„Ù†Ù…Ø· "Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø®ØªØ§Ø±Ø©" Ù†ÙÙ„ØªØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
  if(s.wheelMode==="group"){
    if(!s.chosenGroup) return alert("Ø§Ø®ØªØ§Ø±ÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† Ø¹Ø¬Ù„Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª.");
    pool = pool.filter(st=>st.group===s.chosenGroup);
    if(!pool.length) return alert("Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø·Ø§Ù„Ø¨Ø§Øª. Ø§Ø³Ù†Ø¯ÙŠ Ø·Ø§Ù„Ø¨Ø§Øª Ù„Ù‡Ø§ Ø£ÙˆÙ„Ø§Ù‹.");
  }

  if(s.noRepeatStudents){
    const left = pool.filter(st => !s.usedStudentIds.includes(st.id));
    if(left.length) pool = left;
    else s.usedStudentIds = [];
  }

  const pick = pool[Math.floor(Math.random()*pool.length)];
  s.pickedId = pick.id;
  if(s.noRepeatStudents) s.usedStudentIds.push(pick.id);

  spinAnim("wheelStudent","s");
  setTimeout(()=>{
    const gTxt = pick.group ? groupNames[pick.group] : "Ø¨Ø¯ÙˆÙ† Ù…Ø¬Ù…ÙˆØ¹Ø©";
    el("pickStudentResult").innerHTML =
      `<b>Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø·Ø§Ù„Ø¨Ø©:</b> <span class="tag t-gold">${esc(pick.name)}</span> (${pick.id}) â€” <span class="tag t-vio">${esc(gTxt)}</span>`;
    logAct(cname, `ğŸ² Ø¹Ø¬Ù„Ø© Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª: ${pick.name} (${pick.id})`);
    save();
  }, 550);
}

function rewardPicked(){
  const cname=currentClass();
  const s=ensureSession(cname);
  if(!s.pickedId) return alert("Ø¯ÙˆØ±ÙŠ Ø¹Ø¬Ù„Ø© Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª Ø£ÙˆÙ„Ø§Ù‹.");
  addPoints(s.pickedId, +10);
  save();
}
function warnPicked(){
  const cname=currentClass();
  const s=ensureSession(cname);
  if(!s.pickedId) return alert("Ø¯ÙˆØ±ÙŠ Ø¹Ø¬Ù„Ø© Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª Ø£ÙˆÙ„Ø§Ù‹.");
  addWarn(s.pickedId);
  save();
}
function awardGroupPointsPicked(){
  const cname=currentClass();
  const s=ensureSession(cname);
  if(!s.pickedId) return alert("Ø¯ÙˆØ±ÙŠ Ø¹Ø¬Ù„Ø© Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª Ø£ÙˆÙ„Ø§Ù‹.");
  const cls=getClass(cname);
  const st=cls.students.find(x=>x.id===s.pickedId);
  if(!st || !st.group) return alert("Ø§Ù„Ø·Ø§Ù„Ø¨Ø© ØºÙŠØ± Ù…Ø³Ù†Ø¯Ø© Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©.");
  addGroupPoints(st.group, +10);
  save();
}
function awardPointsToChosenGroup(delta){
  const cname=currentClass();
  const s=ensureSession(cname);
  if(!s.chosenGroup) return alert("Ø§Ø®ØªØ§Ø±ÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† Ø¹Ø¬Ù„Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª.");
  addGroupPoints(s.chosenGroup, delta);
  save();
}

/* ===================== Ø§Ù„Ø·Ø§Ù„Ø¨Ø© Ø§Ù„Ø³Ø±Ù‘ÙŠØ© ===================== */
function pickRandomStudent(cls){ return cls.students[Math.floor(Math.random()*cls.students.length)]; }
function setSecret(){
  const cname=currentClass();
  const cls=getClass(cname);
  if(!cls.students.length) return alert("Ø£Ø¶ÙŠÙÙŠ Ø·Ø§Ù„Ø¨Ø§Øª Ø£ÙˆÙ„Ø§Ù‹.");
  const pick = pickRandomStudent(cls);
  cls.secret = pick.id;
  cls.secretHidden = true;
  el("secretBox").textContent = "ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø·Ø§Ù„Ø¨Ø© Ø³Ø±Ù‘ÙŠØ© (Ù…Ø®ÙÙŠØ©).";
  logAct(cname, `ØªØ¹ÙŠÙŠÙ† Ø·Ø§Ù„Ø¨Ø© Ø³Ø±Ù‘ÙŠØ© (${pick.id})`);
  save();
}
function hideSecret(){
  const cname=currentClass();
  const cls=getClass(cname);
  if(!cls.secret) return;
  cls.secretHidden = true;
  el("secretBox").textContent = "Ø§Ù„Ø·Ø§Ù„Ø¨Ø© Ø§Ù„Ø³Ø±Ù‘ÙŠØ© Ù…Ø®ÙÙŠØ©.";
  logAct(cname, "Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø·Ø§Ù„Ø¨Ø© Ø§Ù„Ø³Ø±Ù‘ÙŠØ©");
  save();
}
function revealSecret(){
  const cname=currentClass();
  const cls=getClass(cname);
  if(!cls.secret) return alert("Ù„Ù… ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ† Ø·Ø§Ù„Ø¨Ø© Ø³Ø±Ù‘ÙŠØ© Ø¨Ø¹Ø¯.");
  const st = cls.students.find(x=>x.id===cls.secret);
  if(!st) return alert("Ø§Ù„Ø·Ø§Ù„Ø¨Ø© Ø§Ù„Ø³Ø±Ù‘ÙŠØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© (Ù‚Ø¯ ØªÙƒÙˆÙ† Ø­ÙØ°ÙØª). Ø¹ÙŠÙ‘Ù†ÙŠ Ø³Ø±Ù‘ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©.");
  cls.secretHidden = false;
  el("secretBox").innerHTML = `<b>Ø§Ù„Ø·Ø§Ù„Ø¨Ø© Ø§Ù„Ø³Ø±Ù‘ÙŠØ©:</b> ${esc(st.name)} â€” (${st.id}) â€” <b>${st.group?groupNames[st.group]:"Ø¨Ø¯ÙˆÙ† Ù…Ø¬Ù…ÙˆØ¹Ø©"}</b>`;
  logAct(cname, `Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø·Ø§Ù„Ø¨Ø© Ø§Ù„Ø³Ø±Ù‘ÙŠØ© (${st.id})`);
  save();
}
function newSecret(){
  const cname=currentClass();
  const cls=getClass(cname);
  if(!cls.students.length) return alert("Ø£Ø¶ÙŠÙÙŠ Ø·Ø§Ù„Ø¨Ø§Øª Ø£ÙˆÙ„Ø§Ù‹.");
  const pick = pickRandomStudent(cls);
  cls.secret = pick.id;
  cls.secretHidden = false;
  el("secretBox").innerHTML = `<b>Ø§Ù„Ø·Ø§Ù„Ø¨Ø© Ø§Ù„Ø³Ø±Ù‘ÙŠØ©:</b> ${esc(pick.name)} â€” (${pick.id}) â€” <b>${pick.group?groupNames[pick.group]:"Ø¨Ø¯ÙˆÙ† Ù…Ø¬Ù…ÙˆØ¹Ø©"}</b>`;
  logAct(cname, `Ø³Ø±Ù‘ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©: ${pick.name} (${pick.id})`);
  save();
}

/* ===================== Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ± ===================== */
function renderMsgStudents(cname){
  const sel=el("msgStudent");
  sel.innerHTML="";
  const cls=getClass(cname);
  if(!cls.students.length){
    sel.innerHTML=`<option value="">â€”</option>`;
    return;
  }
  cls.students.forEach((st,i)=>{
    sel.innerHTML += `<option value="${i}">${esc(st.name)} (${st.id})</option>`;
  });
}
function copyToClipboard(text){
  navigator.clipboard.writeText(text)
    .then(()=>alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù†Øµ."))
    .catch(()=>prompt("Ø§Ù†Ø³Ø®ÙŠ Ø§Ù„Ù†Øµ:", text));
}
function copyParentMsg(type){
  const cname=currentClass();
  const cls=getClass(cname);
  const s=ensureSession(cname);
  const idx=el("msgStudent").value;
  if(idx==="") return alert("Ø§Ø®ØªØ§Ø±ÙŠ Ø·Ø§Ù„Ø¨Ø©.");

  const st=cls.students[+idx];
  const status = s.attendance[st.id] ?? 0;
  const statusText = status===0 ? "Ø­Ø¶ÙˆØ±" : status===1 ? "ØºÙŠØ§Ø¨" : "ØªØ£Ø®Ø±";
  const teacherName = (data.meta.teacher || "Ø§Ù„Ù…Ø¹Ù„Ù…Ø©");

  let msg="";
  if(type==="praise"){
    msg =
`ÙˆÙ„ÙŠ Ø£Ù…Ø± Ø§Ù„Ø·Ø§Ù„Ø¨Ø©/ ${st.name} Ø­ÙØ¸Ù‡ Ø§Ù„Ù„Ù‡ØŒ
Ù†Ø­ÙŠØ·ÙƒÙ… Ø¹Ù„Ù…Ù‹Ø§ Ø¨Ø£Ù† Ø§Ø¨Ù†ØªÙƒÙ… Ø£Ø¸Ù‡Ø±Øª Ø§Ù†Ø¶Ø¨Ø§Ø·Ù‹Ø§ ÙˆØªÙØ§Ø¹Ù„Ù‹Ø§ Ù…Ù…ÙŠØ²Ù‹Ø§ Ø®Ù„Ø§Ù„ Ø§Ù„Ø­ØµØ©ØŒ ÙˆÙ†Ø´ÙƒØ± Ø¯Ø¹Ù…ÙƒÙ… Ø§Ù„Ù…ØªÙˆØ§ØµÙ„.
${teacherName}`;
  }else if(type==="warn"){
    msg =
`ÙˆÙ„ÙŠ Ø£Ù…Ø± Ø§Ù„Ø·Ø§Ù„Ø¨Ø©/ ${st.name} Ø­ÙØ¸Ù‡ Ø§Ù„Ù„Ù‡ØŒ
Ù„ÙˆØ­Ø¸ Ø¹Ù„Ù‰ Ø§Ø¨Ù†ØªÙƒÙ… Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø³Ù„ÙˆÙƒÙŠØ©/ØªØ´ØªØª Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ØµØ©ØŒ ÙˆÙ†Ø£Ù…Ù„ Ù…Ù†ÙƒÙ… Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© ÙˆØ§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ø§Ù†Ø¶Ø¨Ø§Ø·.
${teacherName}`;
  }else{
    msg =
`ÙˆÙ„ÙŠ Ø£Ù…Ø± Ø§Ù„Ø·Ø§Ù„Ø¨Ø©/ ${st.name} Ø­ÙØ¸Ù‡ Ø§Ù„Ù„Ù‡ØŒ
Ù†ÙÙŠØ¯ÙƒÙ… Ø¨Ø£Ù† Ø­Ø§Ù„Ø© Ø§Ø¨Ù†ØªÙƒÙ… Ø§Ù„ÙŠÙˆÙ…: ${statusText}.
Ù†Ø£Ù…Ù„ ØªØ²ÙˆÙŠØ¯Ù†Ø§ Ø¨Ø³Ø¨Ø¨ Ø°Ù„ÙƒØŒ Ø´Ø§ÙƒØ±ÙŠÙ† ØªØ¹Ø§ÙˆÙ†ÙƒÙ….
${teacherName}`;
  }

  el("parentMsgBox").textContent = msg;
  copyToClipboard(msg);
}

/* ===================== Ø§Ù„Ø¹Ø±Ø¶ ===================== */
function renderRoster(cname){
  const cls=getClass(cname);
  const s=ensureSession(cname);
  const box=el("roster");

  if(!cls.students.length){
    box.innerHTML = `<div class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ø§Ù„Ø¨Ø§Øª Ø¨Ø¹Ø¯. Ø£Ø¶ÙŠÙÙŠ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª Ø£ÙˆÙ„Ø§Ù‹.</div>`;
    return;
  }

  const list = cls.students.slice().sort((a,b)=>a.id.localeCompare(b.id));

  box.innerHTML = list.map(st=>{
    const pts=s.points[st.id] ?? 0;
    const wrn=s.warns[st.id] ?? 0;
    const att=s.attendance[st.id] ?? 0;
    const g = st.group || 0;
    const gText = g ? `${groupNames[g]}` : "Ø¨Ø¯ÙˆÙ† Ù…Ø¬Ù…ÙˆØ¹Ø©";
    const picked = (s.pickedId===st.id) ? ` <span class="tag t-gold">Ù…Ø®ØªØ§Ø±Ø©</span>` : "";
    return `
      <div class="rosterItem">
        <div style="flex:1">
          <div>
            <span class="drag tag t-vio" draggable="true" ondragstart="dragStudent(event,'${st.id}')">Ø§Ø³Ø­Ø¨</span>
            <b>${esc(st.name)}</b>${picked} <span class="small">(${st.id})</span>
          </div>
          <div class="small">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©: <b>${esc(gText)}</b> â€¢ ${statusTag(att)} â€¢ Ù†Ù‚Ø§Ø·: <b style="color:var(--gold)">${pts}</b> â€¢ ØªÙ†Ø¨ÙŠÙ‡: <b style="color:var(--warn)">${wrn}</b></div>
        </div>
        <div style="display:flex;flex-direction:column;gap:6px;min-width:240px">
          <input value="${esc(st.name)}" onchange="editStudentName('${st.id}', this.value)" />
          <div class="btns" style="justify-content:flex-end">
            <button class="ghost" onclick="toggleAttendance('${st.id}')">Ø§Ù„Ø­Ø¶ÙˆØ±</button>
            <button class="ok" onclick="addPoints('${st.id}', +5); save()">+5</button>
            <button class="ok" onclick="addPoints('${st.id}', +10); save()">+10</button>
            <button class="warn" onclick="addWarn('${st.id}'); save()">ØªÙ†Ø¨ÙŠÙ‡</button>
            <button class="bad" onclick="deleteStudent('${st.id}')">Ø­Ø°Ù</button>
          </div>
        </div>
      </div>
    `;
  }).join("");
}

function renderGroups(cname){
  const cls=getClass(cname);
  const s=ensureSession(cname);

  for(let g=1; g<=4; g++){
    const members = cls.students.filter(st=>st.group===g);
    const groupPts = s.groupPoints[g] ?? 0;

    const box=el("g"+g);
    box.innerHTML = `
      <div class="groupTitle">
        <div>${groupNames[g]}</div>
        <div class="small">Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©: <b style="color:var(--gold)">${groupPts}</b></div>
      </div>
      <div class="dropHint">Ø§Ø³Ø­Ø¨ÙŠ Ø§Ù„Ø·Ø§Ù„Ø¨Ø© Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØµÙ ÙˆØ£Ø³Ù‚Ø·ÙŠÙ‡Ø§ Ù‡Ù†Ø§ Ù„Ø¥Ø³Ù†Ø§Ø¯Ù‡Ø§ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©.</div>
      <div class="groupList" id="g${g}list"></div>
    `;

    const listEl = el("g"+g+"list");
    if(!members.length){
      listEl.innerHTML = `<div class="small">â€” Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ø§Ù„Ø¨Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© â€”</div>`;
      continue;
    }

    listEl.innerHTML = members
      .slice()
      .sort((a,b)=>a.id.localeCompare(b.id))
      .map(st=>{
        const att=s.attendance[st.id] ?? 0;
        const pts=s.points[st.id] ?? 0;
        const wrn=s.warns[st.id] ?? 0;
        return `
          <div class="stRow">
            <div>
              <div class="name">${esc(st.name)} <span class="small">(${st.id})</span></div>
              <div class="small">${statusTag(att)} â€¢ Ù†Ù‚Ø§Ø·: <b style="color:var(--gold)">${pts}</b> â€¢ ØªÙ†Ø¨ÙŠÙ‡: <b style="color:var(--warn)">${wrn}</b></div>
            </div>
            <div class="miniBtns">
              <button class="ghost" onclick="toggleAttendance('${st.id}')">Ø§Ù„Ø­Ø¶ÙˆØ±</button>
              <button class="ok" onclick="addPoints('${st.id}',+10);save()">+10</button>
              <button class="warn" onclick="addWarn('${st.id}');save()">ØªÙ†Ø¨ÙŠÙ‡</button>
            </div>
          </div>
        `;
      }).join("");
  }
}

function renderKashfTable(cname){
  const cls=getClass(cname);
  const s=ensureSession(cname);
  const t=el("kashfTable");

  if(!cls.students.length){
    t.innerHTML = `<tr><th>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ø§Ù„Ø¨Ø§Øª</th></tr>`;
    return;
  }

  let rows = `
    <tr>
      <th>Ø§Ù„Ø±Ù‚Ù…</th>
      <th>Ø§Ù„Ø§Ø³Ù…</th>
      <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</th>
      <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
      <th>Ù†Ù‚Ø§Ø·</th>
      <th>ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</th>
    </tr>
  `;

  cls.students.slice().sort((a,b)=>a.id.localeCompare(b.id)).forEach(st=>{
    const stt=s.attendance[st.id] ?? 0;
    const pts=s.points[st.id] ?? 0;
    const wrn=s.warns[st.id] ?? 0;
    const g = st.group || 0;
    rows += `
      <tr>
        <td>${st.id}</td>
        <td>${esc(st.name)}</td>
        <td>${g? groupNames[g] : "â€”"}</td>
        <td><button class="ghost" onclick="toggleAttendance('${st.id}')">${statusTag(stt)}</button></td>
        <td><span class="tag t-vio">${pts}</span></td>
        <td><span class="tag t-warn">${wrn}</span></td>
      </tr>
    `;
  });

  t.innerHTML = rows;
}

function renderSessionLog(cname){
  const s=ensureSession(cname);
  el("sessionLog").value = s.log || "";
}

function renderSecretBox(cname){
  const cls=getClass(cname);
  if(cls.secret && !cls.secretHidden){
    const st = cls.students.find(x=>x.id===cls.secret);
    el("secretBox").innerHTML = st ? `<b>Ø§Ù„Ø·Ø§Ù„Ø¨Ø© Ø§Ù„Ø³Ø±Ù‘ÙŠØ©:</b> ${esc(st.name)} â€” (${st.id}) â€” <b>${st.group?groupNames[st.group]:"Ø¨Ø¯ÙˆÙ† Ù…Ø¬Ù…ÙˆØ¹Ø©"}</b>` : "â€”";
  }else if(cls.secret && cls.secretHidden){
    el("secretBox").textContent = "Ø§Ù„Ø·Ø§Ù„Ø¨Ø© Ø§Ù„Ø³Ø±Ù‘ÙŠØ© Ù…Ø®ÙÙŠØ©.";
  }else{
    el("secretBox").textContent = "â€”";
  }
}

function renderWheelStudentsList(cname){
  const cls=getClass(cname);
  if(!cls.students.length){
    el("wheelStudentsList").textContent = "â€”";
    return;
  }
  const names = cls.students
    .slice()
    .sort((a,b)=>a.id.localeCompare(b.id))
    .map(s=>`${s.name} (${s.id})`)
    .join(" â€¢ ");
  el("wheelStudentsList").textContent = names;
}

/* ===================== Ø·Ø¨Ø§Ø¹Ø© ÙƒØ´Ù (Ø­Ù„ Ø£ÙˆØ¶Ø­) ===================== */
function printKashf(){
  const cname=currentClass();
  const cls=getClass(cname);
  const s=ensureSession(cname);

  const rows = cls.students.slice().sort((a,b)=>a.id.localeCompare(b.id)).map(st=>{
    const stt=s.attendance[st.id] ?? 0;
    const status = stt===0 ? "Ø­Ø§Ø¶Ø±Ø©" : stt===1 ? "ØºØ§Ø¦Ø¨Ø©" : "Ù…ØªØ£Ø®Ø±Ø©";
    const g = st.group || 0;
    return `<tr>
      <td>${st.id}</td>
      <td>${esc(st.name)}</td>
      <td>${g? groupNames[g] : "â€”"}</td>
      <td>${status}</td>
      <td>${s.points[st.id]??0}</td>
      <td>${s.warns[st.id]??0}</td>
    </tr>`;
  }).join("");

  const html = `
<!doctype html><html lang="ar" dir="rtl"><head><meta charset="utf-8">
<title>ÙƒØ´Ù ${cname}</title>
<style>
body{font-family:Tahoma; padding:18px}
h2{margin:0 0 8px}
.small{color:#555;line-height:1.6}
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{border:1px solid #333;padding:8px;text-align:center}
th{background:#f2f2f2}
</style></head><body>
<h2>ÙƒØ´Ù Ø§Ù„ØµÙ â€” ${cname}</h2>
<div class="small">${esc(data.meta.school||"")}</div>
<div class="small">${esc(data.meta.principal||"")}</div>
<div class="small">${esc(data.meta.teacher||"")}</div>
<div class="small">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙƒØ´Ù: ${s.date}</div>
<table>
<tr><th>Ø§Ù„Ø±Ù‚Ù…</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ù†Ù‚Ø§Ø·</th><th>ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</th></tr>
${rows}
</table>
</body></html>`;

  // Ø·Ø¨Ø§Ø¹Ø© Ø¹Ø¨Ø± iframe Ù„ØªÙ‚Ù„ÙŠÙ„ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø­Ø¸Ø±
  const iframe = document.createElement("iframe");
  iframe.style.position="fixed";
  iframe.style.right="0";
  iframe.style.bottom="0";
  iframe.style.width="0";
  iframe.style.height="0";
  iframe.style.border="0";
  document.body.appendChild(iframe);
  const doc = iframe.contentWindow.document;
  doc.open(); doc.write(html); doc.close();
  iframe.onload = () => {
    iframe.contentWindow.focus();
    iframe.contentWindow.print();
    setTimeout(()=>document.body.removeChild(iframe), 800);
  };
}

/* ===================== ØªØµØ¯ÙŠØ±/Ø§Ø³ØªÙŠØ±Ø§Ø¯/Ø­Ø°Ù ===================== */
function exportJSON(){
  const txt=JSON.stringify(data,null,2);
  copyToClipboard(txt);
}
function importJSON(){
  const txt=prompt("Ø§Ù„ØµÙ‚ÙŠ JSON Ù‡Ù†Ø§ Ù„Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ (Ø³ÙŠØ³ØªØ¨Ø¯Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©):");
  if(!txt) return;
  try{
    const obj=JSON.parse(txt);
    if(!obj || typeof obj!=="object") throw new Error("bad");
    data=obj;
    if(!data.meta) data.meta=defaultData().meta;
    if(!data.classes) data.classes=defaultData().classes;
    if(!data.sessions) data.sessions={};
    if(!data.classOrder) data.classOrder=defaultData().classOrder;
    save();
    alert("ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­.");
  }catch(e){
    alert("JSON ØºÙŠØ± ØµØ§Ù„Ø­.");
  }
}
function wipeAll(){
  if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ÙŠÙ† Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²ØŸ")){
    localStorage.removeItem(STORE);
    data=defaultData();
    save();
    alert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
    el("app").classList.add("hidden");
    el("cover").classList.remove("hidden");
    renderMeta();
  }
}

/* ===================== Ù…Ø²Ø§Ù…Ù†Ø© ÙƒØ§Ù…Ù„Ø© ===================== */
function syncAll(){
  renderMeta();
  renderClassSelector();

  const cname=currentClass();
  const s=ensureSession(cname);

  el("teacherEmail").value = data.meta.email || "";
  el("emailHint").textContent = "Ø§Ù„Ù…Ø­ÙÙˆØ¸: " + (data.meta.email || "â€”");
  el("appEmail").textContent = "Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø¹Ù„Ù…Ø©: " + (data.meta.email || "â€”");

  if(s.noisy){
    el("classStatusBox").innerHTML = `âš ï¸ <b>Ø¥Ù†Ø°Ø§Ø±:</b> Ø§Ù„ÙØµÙ„ Ù…Ø²Ø¹Ø¬ â€” Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª: <b>${s.warnings}</b>`;
  }else if(s.praise>0){
    el("classStatusBox").innerHTML = `ğŸŒŸ <b>ØªØ¹Ø²ÙŠØ²:</b> Ø§Ù„ÙØµÙ„ Ù…ØªØ¹Ø§ÙˆÙ† â€” ØªØ¹Ø²ÙŠØ²Ø§Øª: <b>${s.praise}</b> â€” Ø¥Ù†Ø°Ø§Ø±Ø§Øª: <b>${s.warnings}</b>`;
  }else{
    el("classStatusBox").textContent = "â€”";
  }

  // ØªØ­Ø¯ÙŠØ« Ù†Øµ Ù†Ù…Ø· Ø¹Ø¬Ù„Ø© Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª
  el("wheelModeTxt").textContent = (s.wheelMode==="all") ? "ÙƒÙ„ Ø§Ù„ØµÙ" : "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©";

  // ØªØ­Ø¯ÙŠØ« Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¹Ø¬Ù„Ø§Øª (Ø¨Ø¯ÙˆÙ† Ø¥ÙØ³Ø§Ø¯ Ø¢Ø®Ø± Ù†ØªÙŠØ¬Ø©)
  const chosen = s.chosenGroup ? groupNames[s.chosenGroup] : null;
  el("pickGroupResult").innerHTML = chosen ? `<b>Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©:</b> <span class="tag t-vio">${chosen}</span>` : `<b>Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©:</b> â€”`;

  if(s.pickedId){
    const cls=getClass(cname);
    const st=cls.students.find(x=>x.id===s.pickedId);
    if(st){
      const gTxt = st.group ? groupNames[st.group] : "Ø¨Ø¯ÙˆÙ† Ù…Ø¬Ù…ÙˆØ¹Ø©";
      el("pickStudentResult").innerHTML = `<b>Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø·Ø§Ù„Ø¨Ø©:</b> <span class="tag t-gold">${esc(st.name)}</span> (${st.id}) â€” <span class="tag t-vio">${esc(gTxt)}</span>`;
    }else{
      el("pickStudentResult").innerHTML = `<b>Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø·Ø§Ù„Ø¨Ø©:</b> â€”`;
    }
  }else{
    el("pickStudentResult").innerHTML = `<b>Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø·Ø§Ù„Ø¨Ø©:</b> â€”`;
  }

  renderMsgStudents(cname);
  renderSecretBox(cname);
  renderRoster(cname);
  renderGroups(cname);
  renderKashfTable(cname);
  renderSessionLog(cname);
  renderWheelStudentsList(cname);
}

/* ØªØ´ØºÙŠÙ„ */
renderMeta();
syncAll();
</script>
</body>
</html>00
